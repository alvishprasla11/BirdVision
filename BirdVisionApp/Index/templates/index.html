<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bird Vision</title>
  <style>
    video {
      border: 1px solid black;
    }
    canvas {
      display: none;
    }
    .error-message {
      color: red;
      margin: 10px 0;
    }
    #permissionBtn {
      padding: 10px 20px;
      margin: 10px 0;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #permissionBtn:hover {
      background-color: #45a049;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<h1>Bird Vision</h1>

<div id="errorMessage" class="error-message hidden"></div>
<button id="permissionBtn" class="hidden">Enable Camera Access</button>

<video id="video" width="640" height="480" autoplay></video>
<br>
<button id="captureBtn">Capture Image</button>
<br><br>
<canvas id="canvas" width="640" height="480"></canvas>
<img id="capturedImage" alt="" width="640">

<script>
  const video = document.getElementById('video');
  const captureBtn = document.getElementById('captureBtn');
  const ctx = canvas.getContext('2d');
  const errorMessage = document.getElementById('errorMessage');
  const permissionBtn = document.getElementById('permissionBtn');

  // Function to start video stream from camera
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      // Hide error message and permission button if camera starts successfully
      errorMessage.classList.add('hidden');
      permissionBtn.classList.add('hidden');
    } catch (err) {
      console.error('Error accessing the camera: ', err);
      // Show error message and permission button
      errorMessage.textContent = 'Camera access is blocked. Please enable camera access to use this feature.';
      errorMessage.classList.remove('hidden');
      permissionBtn.classList.remove('hidden');
    }
  }

  permissionBtn.addEventListener('click', () => {
    startCamera();
  });

  // Capture image when the button is clicked and save it automatically
  captureBtn.addEventListener('click', () => {
    if (!video.srcObject) {
        errorMessage.textContent = 'Please enable camera access first';
        errorMessage.classList.remove('hidden');
        return;
    }
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/png');  // Get the image data as a base64 URL

    // Create a File object from the base64 image data
    const byteString = atob(imageData.split(',')[1]);  // Decode base64 to binary
    const arrayBuffer = new ArrayBuffer(byteString.length);  // Create an ArrayBuffer
    const uint8Array = new Uint8Array(arrayBuffer);  // Create a Uint8Array
    for (let i = 0; i < byteString.length; i++) {
        uint8Array[i] = byteString.charCodeAt(i);  // Convert each character to byte
    }

    // Create a Blob object from the Uint8Array (for use in file functions)
    const blob = new Blob([uint8Array], { type: 'image/png' });
    // Create a File object from the Blob
    const file = new File([blob], 'captured_image.png', { type: 'image/png' });

    // Call the readURL function with the created File object
    const fileInput = { files: [file] };  // Mocking the input.files property
    readURL(fileInput);  // Pass the file to the readURL function
});

  window.onload = startCamera;
</script>

<br>

<input id="imageUpload" type="file" />

<br>


<img id="imagePreview" style="height: 300px;" />
<br>

		<div id="label-container"></div>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
		<script type="text/javascript">
			// More API functions here:
			// https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

			// the link to your model provided by Teachable Machine export panel
			const URL = 'https://teachablemachine.withgoogle.com/models/-1r0AX8_Z/';

			let model, labelContainer, maxPredictions;

			// Load the image model
			async function init() {
				const modelURL = URL + 'model.json';
				const metadataURL = URL + 'metadata.json';

				// load the model and metadata
				model = await tmImage.load(modelURL, metadataURL);
				maxPredictions = model.getTotalClasses();

				labelContainer = document.getElementById('label-container');
				for (let i = 0; i < maxPredictions; i++) {
					// and class labels
					labelContainer.appendChild(document.createElement('div'));
				}
			}

			async function predict() {
				// predict can take in an image, video or canvas html element
				var image = document.getElementById('imagePreview');
				const prediction = await model.predict(image, false);
                prediction.sort(function(a, b) {return b.probability - a.probability});
                let NUM_PREDICTIONS = 1
				for (let i = 0; i < NUM_PREDICTIONS; i++) {
					const classPrediction =
						prediction[i].className + ': ' + prediction[i].probability.toFixed(2);
					labelContainer.childNodes[i].innerHTML = classPrediction;
				}
			}
		</script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script type="text/javascript">
			function readURL(input) {
				if (input.files && input.files[0]) {
					var reader = new FileReader();
					reader.onload = function (e) {
						$('#imagePreview').attr('src', e.target.result);
						// $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
						$('#imagePreview').hide();
						$('#imagePreview').fadeIn(650);
					};
					reader.readAsDataURL(input.files[0]);
					init().then(() => {
						predict();
					});
				}
			}
			$('#imageUpload').change(function () {
				readURL(this);
			});
		</script>

</body>
</html>
